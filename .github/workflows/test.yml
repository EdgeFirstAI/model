# GitHub Actions workflow for testing and code quality
#
# This workflow runs tests, performs static analysis, and collects coverage data
# for the EdgeFirst Model project. Coverage is reported to SonarCloud.
#
# Software-only CI: Both g2d-sys and tflitec-sys use libloading (runtime dlopen),
# so cargo build/check/test succeeds without hardware libraries present.
#
# Action Versions (hash-pinned, verified January 2026):
# - actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 (v4.2.2)
# - actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 (v4.2.3)
# - actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f (v6.0.0)
# - actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 (v7.0.0)
# - dtolnay/rust-toolchain@stable
# - taiki-e/install-action@7e574ed8bb89811282a11aecb3fe1d043bf5bf0e (v2)
# - SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 (master)

name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all --check

  clippy:
    name: Lint with Clippy
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-index-

      - name: Cache cargo build
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        with:
          path: target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-clippy-

      - name: Run Clippy (main crate)
        run: cargo clippy -p edgefirst-model --no-deps --all-targets -- -D warnings

      - name: Generate Clippy report for SonarCloud
        run: |
          # Generate JSON report for SonarCloud (allow warnings for report generation)
          cargo clippy -p edgefirst-model --no-deps --all-targets --message-format=json 2>&1 \
            | tee clippy-report.json || true

      - name: Upload Clippy report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: clippy-report
          path: clippy-report.json
          retention-days: 7

  test:
    name: Test and Coverage (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.runner }}
    permissions:
      contents: read
      checks: write
      pull-requests: write
    strategy:
      matrix:
        platform:
          - name: x86_64
            runner: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
          - name: aarch64
            runner: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
          targets: ${{ matrix.platform.target }}

      - name: Install cargo-llvm-cov and cargo-nextest
        uses: taiki-e/install-action@7e574ed8bb89811282a11aecb3fe1d043bf5bf0e  # v2
        with:
          tool: cargo-llvm-cov,cargo-nextest

      - name: Cache cargo registry
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        with:
          path: ~/.cargo/registry/index
          key: ${{ runner.os }}-${{ matrix.platform.name }}-cargo-index
          restore-keys: ${{ runner.os }}-${{ matrix.platform.name }}-cargo-index

      - name: Cache cargo build
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        with:
          path: target
          key: ${{ runner.os }}-${{ matrix.platform.name }}-cargo-test
          restore-keys: ${{ runner.os }}-${{ matrix.platform.name }}-cargo-test

      - name: Run unit tests with coverage
        run: |
          # Run library unit tests with coverage
          # Unit tests exist in: masks.rs
          cargo llvm-cov nextest --workspace --lib --lcov --output-path coverage.lcov

      - name: Upload coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: coverage-${{ matrix.platform.name }}
          path: coverage.lcov
          retention-days: 30
          if-no-files-found: ignore

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-22.04
    needs: [clippy, test]
    if: |
      always() &&
      needs.test.result == 'success' &&
      (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository)

    steps:
      - name: Checkout code
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98  # v4.2.2
        with:
          fetch-depth: 0

      - name: Download coverage artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          pattern: coverage-*
          path: coverage/

      - name: Download Clippy report
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          name: clippy-report
          path: .

      - name: Organize coverage files for SonarCloud
        run: |
          echo "=== Downloaded coverage artifacts ==="
          find coverage/ -type f

          # Collect all LCOV coverage reports
          COVERAGE_REPORTS=$(find coverage/ -name "*.lcov" | tr '\n' ',' | sed 's/,$//')

          echo "=== Coverage report paths ==="
          echo "Coverage reports: $COVERAGE_REPORTS"

          # Export for SonarCloud
          echo "COVERAGE_PATHS=$COVERAGE_REPORTS" >> "$GITHUB_ENV"

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9  # master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.rust.lcov.reportPaths=${{ env.COVERAGE_PATHS }}
            -Dsonar.rust.clippy.reportPaths=clippy-report.json

      - name: Generate coverage summary
        if: always()
        run: |
          echo "# EdgeFirst Model Coverage Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Platform | Architecture | Test Types |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|--------------|------------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Ubuntu 22.04 | x86_64 | Unit tests |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Ubuntu 22.04 ARM | aarch64 | Unit tests |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Full analysis on [SonarCloud](https://sonarcloud.io/dashboard?id=EdgeFirstAI_model)" >> "$GITHUB_STEP_SUMMARY"
