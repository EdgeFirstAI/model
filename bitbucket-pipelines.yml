image: deepview/rust:1.88.0-1

clone:
  depth: full

definitions:
  steps:
    - step: &version
        name: VERSION
        script:
          - |
            if [ -z "$BITBUCKET_TAG" ] ; then
              export VERSION=0.0.0-dev${BITBUCKET_BUILD_NUMBER}
            else
              export VERSION=${BITBUCKET_TAG}
            fi
          - sed -i "s/0.0.0/$VERSION/g" Cargo.toml
          - echo $VERSION
        artifacts:
          - Cargo.toml
    - step: &analyze
        name: Analyze
        size: 2x
        script:
          - cargo clippy --message-format=json > clippy.json || true
          - cargo audit --json > audit.json || true
          - cargo outdated --depth 1 --format json > outdated.json || true
          - cargo sonar --clippy --outdated --audit
        artifacts:
          - sonar-issues.json
    - step: &build-linux-x86_64
        name: Build Linux x86_64
        size: 2x
        script:
          - cargo build --release
        artifacts:
          - target/release/edgefirst-model
    - step: &build-linux-aarch64
        name: Build Linux aarch64
        size: 2x
        script:
          - cargo build --target=aarch64-unknown-linux-gnu --release
        artifacts:
          - target/aarch64-unknown-linux-gnu/release/edgefirst-model
    - step: &sonar
        name: Code Sonar
        runs-on:
          - 'self.hosted'
        image: sonarsource/sonar-scanner-cli:11.3
        script:
          - sonar-scanner
pipelines:
  default:
    - step: *version
    - parallel:
        - step: *analyze
        - step: *build-linux-x86_64
        - step: *build-linux-aarch64
    - step: *sonar
  pull-requests:
    '**':
      - step: *version
      - parallel:
          - step: *analyze
          - step: *build-linux-x86_64
          - step: *build-linux-aarch64
      - step: *sonar
      - step:
          name: Deploy
          deployment: Test
          script:
            - echo "Deploy Pull-Request"
  tags:
    '*.*.*':
      - step: *version
      - parallel:
          - step: *build-linux-x86_64
          - step: *build-linux-aarch64
      - step:
          name: Deploy to Production
          deployment: Production
          script:
            - cp target/release/edgefirst-model edgefirst-model-$BITBUCKET_TAG-linux-x86_64
            - cp target/aarch64-unknown-linux-gnu/release/edgefirst-model edgefirst-model-$BITBUCKET_TAG-linux-aarch64            
            - pipe: atlassian/bitbucket-upload-file:0.7.4
              variables:
                BITBUCKET_USERNAME: au-zone-ci
                BITBUCKET_APP_PASSWORD: $BITBUCKET_PASSWORD
                FILENAME: "edgefirst-model-$BITBUCKET_TAG-*"
            - pipe: atlassian/aws-s3-deploy:2.0.1
              variables:
                AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
                AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY
                AWS_DEFAULT_REGION: 'us-west-2'
                S3_BUCKET: "maivin/services/model"
                LOCAL_PATH: "."
                EXTRA_ARGS: "--exclude=* --include=edgefirst-model-$BITBUCKET_TAG-*"